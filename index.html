<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRO STORE FINAL</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;font-family:sans-serif;background:#0f172a;color:white}
.center{display:flex;justify-content:center;align-items:center;height:100vh}
.box{background:#1e293b;padding:30px;border-radius:15px;width:320px}
input{width:100%;padding:10px;margin:5px 0;border-radius:8px;border:none}
button{padding:10px;border:none;border-radius:8px;cursor:pointer}
.main{background:#22c55e;color:black;width:100%}
nav{display:flex;gap:15px;padding:15px;background:#111827}
.section{display:none;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px}
.card{background:#1e293b;padding:15px;border-radius:15px;text-align:center}
.card img{width:100%;height:150px;object-fit:cover;border-radius:10px}
</style>
</head>
<body>

<div id="auth" class="center">
  <div class="box">
    <h2>เข้าสู่ระบบ</h2>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button class="main" onclick="login()">Login</button>
    <br><br>
    <button onclick="register()">สมัครสมาชิก</button>
    <p id="authMsg"></p>
  </div>
</div>

<div id="app" style="display:none;">
  <nav id="navbar"></nav>

  <div id="shop" class="section"></div>
  <div id="orders" class="section"></div>
  <div id="admin" class="section"></div>
</div>

<script>
const supabase = window.supabase.createClient(
"https://fmykgxcnrbzjcwsezthk.supabase.co",
"sb_publishable_AwAtOhcZiPWiz-VQuKPjWQ_XGvll29G"
)

const adminEmail="oil166922@gmail.com"
let user=null

async function login(){
  const email=emailInput().value
  const password=passwordInput().value
  const { data, error } = await supabase.auth.signInWithPassword({email,password})
  if(error){
    authMsg().innerText=error.message
    return
  }
  user=data.user
  startApp()
}

async function register(){
  const email=emailInput().value
  const password=passwordInput().value
  const { error } = await supabase.auth.signUp({email,password})
  if(error){
    authMsg().innerText=error.message
  }else{
    authMsg().innerText="สมัครสำเร็จ ล็อกอินได้เลย"
  }
}

function emailInput(){return document.getElementById("email")}
function passwordInput(){return document.getElementById("password")}
function authMsg(){return document.getElementById("authMsg")}

async function startApp(){
  document.getElementById("auth").style.display="none"
  document.getElementById("app").style.display="block"

  buildNav()
  show("shop")
  loadProducts()
  loadOrders()
}

function buildNav(){
  const nav=document.getElementById("navbar")
  nav.innerHTML=`
    <button onclick="show('shop')">สินค้า</button>
    <button onclick="show('orders')">ออเดอร์</button>
    ${user.email===adminEmail?'<button onclick="show(\'admin\')">แอดมิน</button>':''}
    <button onclick="logout()">ออก</button>
  `
}

function show(sec){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none")
  document.getElementById(sec).style.display="block"
}

async function loadProducts(){
  const { data, error } = await supabase.from("products").select("*")
  if(error) return
  const shop=document.getElementById("shop")
  shop.innerHTML="<h2>สินค้า</h2><div class='grid'></div>"
  const grid=shop.querySelector(".grid")
  data.forEach(p=>{
    grid.innerHTML+=`
    <div class="card">
      <img src="${p.image||'https://via.placeholder.com/300'}">
      <h4>${p.name}</h4>
      <div>${p.price} บาท</div>
      <button onclick="order('${p.name}',${p.price})">สั่งซื้อ</button>
    </div>`
  })
}

async function order(name,price){
  await supabase.from("orders").insert([{
    user_email:user.email,
    product_name:name,
    price:price
  }])
  alert("สั่งซื้อสำเร็จ")
  loadOrders()
}

async function loadOrders(){
  const { data } = await supabase.from("orders").select("*")
  const orders=document.getElementById("orders")
  orders.innerHTML="<h2>ออเดอร์</h2>"
  data.forEach(o=>{
    if(user.email===adminEmail || o.user_email===user.email){
      orders.innerHTML+=`
      <div class="card">
        <div>${o.product_name}</div>
        <div>${o.price} บาท</div>
        <div>สถานะ: ${o.status||'รอดำเนินการ'}</div>
      </div>`
    }
  })
  if(user.email===adminEmail) buildAdmin()
}

function buildAdmin(){
  const admin=document.getElementById("admin")
  admin.innerHTML=`
    <h2>เพิ่มสินค้า</h2>
    <input id="pname" placeholder="ชื่อสินค้า">
    <input id="pprice" type="number" placeholder="ราคา">
    <input id="pimage" placeholder="ลิงก์รูป">
    <button onclick="addProduct()">เพิ่ม</button>
  `
}

async function addProduct(){
  const name=document.getElementById("pname").value
  const price=document.getElementById("pprice").value
  const image=document.getElementById("pimage").value
  await supabase.from("products").insert([{name,price,image}])
  alert("เพิ่มสินค้าแล้ว")
  loadProducts()
}

function logout(){
  supabase.auth.signOut()
  location.reload()
}

async function checkSession(){
  const { data } = await supabase.auth.getUser()
  if(data.user){
    user=data.user
    startApp()
  }
}

checkSession()
</script>
</body>
</html>
