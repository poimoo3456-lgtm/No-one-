<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PRO STORE V2</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{margin:0;background:#0f172a;color:white;font-family:sans-serif}
nav{display:flex;gap:15px;padding:15px;background:#111827}
nav button{background:none;border:none;color:white;cursor:pointer;font-size:16px}
.section{display:none;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px}
.card{background:#1e293b;padding:15px;border-radius:15px;text-align:center}
.card img{width:100%;height:150px;object-fit:cover;border-radius:10px}
input,select{padding:8px;width:100%;margin:5px 0;border-radius:8px;border:none}
button.main{background:#22c55e;color:black;padding:8px;border:none;border-radius:8px;cursor:pointer}
button.del{background:#ef4444;color:white;margin-top:5px}
.status{font-weight:bold}
</style>
</head>
<body>

<nav id="navbar"></nav>

<div id="shop" class="section"></div>
<div id="orders" class="section"></div>
<div id="admin" class="section"></div>

<script>
const supabase = window.supabase.createClient(
"https://fmykgxcnrbzjcwsezthk.supabase.co",
"sb_publishable_AwAtOhcZiPWiz-VQuKPjWQ_XGvll29G"
)

const adminEmail="oil166922@gmail.com"
let currentUser=null

async function init(){
  const { data } = await supabase.auth.getUser()
  currentUser=data.user
  if(!currentUser){
    const email=prompt("Email")
    const pass=prompt("Password")
    await supabase.auth.signInWithPassword({email:email,password:pass})
    location.reload()
  }
  buildNav()
  show("shop")
  loadProducts()
  loadOrders()
}

function buildNav(){
  const nav=document.getElementById("navbar")
  nav.innerHTML=`
    <button onclick="show('shop')">หน้าร้าน</button>
    <button onclick="show('orders')">ออเดอร์</button>
    ${currentUser.email===adminEmail?'<button onclick="show(\'admin\')">แอดมิน</button>':''}
    <button onclick="logout()">ออก</button>
  `
}

function show(section){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none")
  document.getElementById(section).style.display="block"
}

async function loadProducts(){
  const { data } = await supabase.from("products").select("*")
  const shop=document.getElementById("shop")
  shop.innerHTML="<h2>สินค้า</h2><div class='grid' id='plist'></div>"
  const plist=document.getElementById("plist")
  data.forEach(p=>{
    plist.innerHTML+=`
    <div class="card">
      <img src="${p.image||'https://via.placeholder.com/300'}">
      <h4>${p.name}</h4>
      <div>${p.price} บาท</div>
      <button class="main" onclick="orderProduct('${p.name}',${p.price})">สั่งซื้อ</button>
    </div>`
  })
}

async function orderProduct(name,price){
  await supabase.from("orders").insert([{
    user_email:currentUser.email,
    product_name:name,
    price:price
  }])
  alert("สั่งซื้อแล้ว")
  loadOrders()
}

async function loadOrders(){
  const { data } = await supabase.from("orders").select("*")
  const ordersDiv=document.getElementById("orders")
  ordersDiv.innerHTML="<h2>ออเดอร์</h2>"
  
  let total=0

  data.forEach(o=>{
    if(currentUser.email===adminEmail || o.user_email===currentUser.email){
      total+=Number(o.price)
      ordersDiv.innerHTML+=`
      <div class="card">
        <div>${o.product_name}</div>
        <div>${o.price} บาท</div>
        <div class="status">สถานะ: ${o.status}</div>
        ${o.slip?`<img src="${o.slip}" height="80">`:''}
        ${currentUser.email!==adminEmail?`
          <input placeholder="ลิงก์สลิป" onchange="uploadSlip('${o.id}',this.value)">
        `:''}
        ${currentUser.email===adminEmail?`
          <select onchange="updateStatus('${o.id}',this.value)">
            <option>รอดำเนินการ</option>
            <option>อนุมัติ</option>
            <option>ยกเลิก</option>
          </select>
        `:''}
      </div>`
    }
  })

  if(currentUser.email===adminEmail){
    ordersDiv.innerHTML+=`<h3>ยอดรวม: ${total} บาท</h3>`
  }

  if(currentUser.email===adminEmail){
    buildAdmin()
  }
}

async function uploadSlip(id,link){
  await supabase.from("orders").update({slip:link}).eq("id",id)
}

async function updateStatus(id,status){
  await supabase.from("orders").update({status:status}).eq("id",id)
  loadOrders()
}

function buildAdmin(){
  const admin=document.getElementById("admin")
  admin.innerHTML=`
    <h2>เพิ่มสินค้า</h2>
    <input id="pname" placeholder="ชื่อสินค้า">
    <input id="pprice" type="number" placeholder="ราคา">
    <input id="pimage" placeholder="ลิงก์รูป">
    <button class="main" onclick="addProduct()">เพิ่ม</button>
  `
}

async function addProduct(){
  const name=pname.value
  const price=pprice.value
  const image=pimage.value
  await supabase.from("products").insert([{name,price,image}])
  loadProducts()
}

function logout(){
  supabase.auth.signOut()
  location.reload()
}

init()
</script>
</body>
</html>
